{
    "collab_server" : "",
    "contents" : "##############################################################################\n# title         : 02 - A2 2050 SimCastMeta_Global_Late_Blight_Risk.R;\n# purpose       : create global potato late blight risk using SimCastMeta with A2 2050 data;\n# producer      : prepared by A. Sparks;\n# last update   : in Los Ba√±os, Laguna, Jan 2016;\n# inputs        : A2 2050 time-slice climate data;\n# outputs       : Predictions of late blight severity from SimCastMeta for the A2 scenario, 2050 time-slice;\n# remarks 1     : EcoCrop A2 2050 Potato Growing Seasons.R must be run to generate the planting\n#                 date raster before this script is used. If it is not, the EcoCrop planting date\n#                 script will automatically run and generate the necessary file;\n# Licence:      : GPL2;\n##############################################################################\n\n# Libraries --------------------------------------------------------------------\nlibrary(mgcv)\nlibrary(raster)\nlibrary(readr)\n\nsource(\"Functions/Get_A2_Data.R\")\n# Load data --------------------------------------------------------------------\n# Download A2 climate data files from Figshare. \n# This will take a while if you've not already done it\ndownload_A2_data() \n\nif (file.exists(\"Cache/Planting Seasons/A2_2050_Combined.tif\") == TRUE) {\n  poplant <- raster(\"Cache/Planting Seasons/A2_2050_Combined.tif\")\n  } else source(\"Models/Ecocrop A2 Scenario Potato Growing Seasons.R\")\n\n# Select ONLY ONE, resistant or susceptible blight units for the model run\n\nblight_units <- read_tsv(\"Cache/Blight Units/monthly_susceptible_blight_units.txt\")\n#blight_units <- read_tsv(\"Cache/Blight Units/monthly_resistant_blight_units.txt\")\n\n# Modeling --------------------------------------------------------------------\nmodel_data <- subset(blight_units, Year <= 1992)\n\nSimCastMeta <- gam(Blight~s(C, RH, k = 150), data = model_data)\n\n# sort out the different time-slices, most analysis was with 2050 only so it \n# is the only one featured here. Feel free to use the other two time-slices \n# in the same fashion\nreh_stack <- stack(list.files(path = \"Data/A2 Relative Humidity\", \n                              pattern = \"a2rh50[[:digit:]]{2}.tif\",\n                              full.names = TRUE))/10 \ntmp_stack <- stack(list.files(path = \"Data/A2 Average Temperature\", \n                              pattern = \"a2tmp50[[:digit:]]{2}.tif\", \n                              full.names = TRUE))/10 \n\nreh_stack <- mask(reh_stack, poplant)\ntmp_stack <- mask(tmp_stack, poplant)\n\nfor (i in 1:12) {\n  x <- stack(tmp_stack[[i]], reh_stack[[i]])\n  names(x) <- c(\"C\", \"RH\")\n  y <- predict(x, SimCastMeta, progress = \"text\")\n  y[y < 0] = 0\n  names(y) <- paste(i)\n  if (i == 1) {z <- y} else z <- stack(z, y)\n  i <- i + 1\n}\n\nfor (j in 1:12) {\n  if (j == 1) {\n    w <- reclassify(poplant, c(01, 12, NA))\n    x <- stack(z[[j]], z[[j + 1]], z[[j + 2]])\n    x <- mask(x, w)\n    y <- mean(x)\n  } else if (j > 1 && j < 11) {\n    w <- reclassify(poplant, c(0, paste(\"0\", j - 1, sep = \"\"), NA))\n    w <- reclassify(w, c(paste(\"0\", j, sep = \"\"), 12, NA))\n    x <- stack(z[[j]], z[[j + 1]], z[[j + 2]])\n    x <- mask(x, w)\n    a <- mean(x)\n    y <- cover(y, a)\n  } else if (j == 11) {\n    w <- reclassify(poplant, c(0, 10, NA))\n    w <- reclassify(w, c(11, 12, NA))\n    x <- stack(z[[11]], z[[12]], z[[1]])\n    x <- mask(x, w)\n    a <- mean(x)\n    y <- cover(y, a)\n  }  else\n    w <- reclassify(poplant, c(0, 11, NA))\n  x <- stack(z[[12]], z[[1]], z[[2]])\n  x <- mask(x, w)\n  a <- mean(x)\n  global_blight_risk <- cover(y, a) \n}\n\n# Data visulasation ------------------------------------------------------------\nplot(global_blight_risk, main = \"Average Daily Blight Unit Accumulation\\nPer Three Month Growing Season\\n2050\", xlab = \"Longitude\", ylab = \"Latitude\",\n     legend.args = list(text = \"Blight\\nUnits\", side = 3, font = 2, line = 1, cex = 0.8))\n\n# Save the results for further use or analysis ---------------------------------\nif (max(blight_units$Blight == 6.39)) { # check to see whether we've used resistant or susceptible blight units for this analysis and assign new file name accordingly\n  writeRaster(global_blight_risk, \"Cache/Global Blight Risk Maps/A2_SimCastMeta_Susceptible_Prediction.tif\",\n              format = \"GTiff\", dataType = \"INT2S\", \n              options = c(\"COMPRESS=LZW\"), \n              overwrite = TRUE)\n} else\n  writeRaster(global_blight_risk, \"Cache/Global Blight Risk Maps/A2_SimCastMeta_Resistant_Prediction.tif\",\n              format = \"GTiff\", dataType = \"INT2S\", \n              options = c(\"COMPRESS=LZW\"), \n              overwrite = TRUE)\n\n# eos\n",
    "created" : 1467176967662.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3541913961",
    "id" : "B16DBB3F",
    "lastKnownWriteTime" : 1467181121,
    "last_content_update" : 1467181121852,
    "path" : "~/Development/Global-Late-Blight-MetaModelling/02 - Analysis/02 - A2 2050 SimCastMeta_Global_Late_Blight_Risk.R",
    "project_path" : "02 - Analysis/02 - A2 2050 SimCastMeta_Global_Late_Blight_Risk.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}